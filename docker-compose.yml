services:
  # Redis
  redis:
    image: redis:7-alpine
    container_name: meeting-bot-redis-${CLIENT_NAME:-cais}-${ENV_TAG:-dev}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - meeting-bot-network

  # Combined Frontend and Backend from merged repository
  app:
    image: node:18-alpine
    working_dir: /app
    command: |
      sh -c "
        apk add --no-cache git openssh-client python3 py3-pip wget &&
        mkdir -p /root/.ssh &&
        chmod 700 /root/.ssh &&
        printf \"%s\" \"$APP_SSH_KEY\" | base64 -d > /root/.ssh/id_ed25519 &&
        chmod 600 /root/.ssh/id_ed25519 &&
        ssh-keyscan -H github.com >> /root/.ssh/known_hosts &&
        if [ ! -f /app/package.json ]; then
          GIT_SSH_COMMAND='ssh -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no' git clone --branch ${APP_BRANCH:-main} git@github.com:customaistudio/meahana-attendee.git . 
        fi &&
        echo 'Installing frontend dependencies...' &&
        cd frontend && npm install && cd .. &&
        echo 'Installing backend dependencies...' &&
        cd backend &&
        echo 'Using requirements.txt from repository...' &&
        echo 'Creating Python virtual environment...' &&
        python3 -m venv venv &&
        echo 'Activating virtual environment...' &&
        source venv/bin/activate &&
        echo 'Installing dependencies in virtual environment...' &&
        pip install --no-cache-dir -r requirements.txt &&
        echo '✅ Backend dependencies installed' &&
        echo 'Using Supabase REST API - no direct database setup needed' &&
        echo '✅ Supabase configuration complete' &&
        cd .. &&
        echo 'Verifying environment setup...' &&
        echo 'Node version:' && node --version &&
        echo 'Python version:' && python3 --version &&
        echo 'Backend directory contents:' && ls -la backend/ &&
        echo 'Checking if main.py exists...' && ls -la backend/app/ || echo 'app directory not found' &&
        echo 'Installing concurrently globally...' &&
        npm install -g concurrently &&
        echo 'Starting both frontend and backend with verbose logging...' &&
        concurrently --kill-others --prefix-colors \"bgBlue.bold,bgMagenta.bold\" --prefix \"[FRONTEND]\" --prefix \"[BACKEND]\" \"echo 'Starting frontend on port 3000...' && cd frontend && npm run start\" \"echo 'Starting backend on port 8000...' && cd backend && echo 'Starting uvicorn with direct venv path...' && ./venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000 --log-level debug\"
      "
    container_name: app-${CLIENT_NAME:-cais}-${ENV_TAG:-dev}
    ports:
      - "3000:3000"  # Frontend
      - "8000:8000"  # Backend API
    environment:
      # Frontend environment
      - REACT_APP_API_URL=${REACT_APP_API_URL:-http://localhost:8000}
      - CHOKIDAR_USEPOLLING=true
      # Backend environment
      - REDIS_URL=redis://redis:6379/0
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-}
      - ATTENDEE_API_KEY=${ATTENDEE_API_KEY:-}
      - ATTENDEE_API_BASE_URL=${ATTENDEE_API_BASE_URL:-https://app.attendee.dev}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-}
      - DEBUG=${DEBUG:-false}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - WEBHOOK_BASE_URL=${WEBHOOK_BASE_URL:-}
      - PRODUCTION_BASE_URL=${PRODUCTION_BASE_URL:-}
      - NGROK_AUTH_TOKEN=${NGROK_AUTH_TOKEN:-}
      - AUTO_START_NGROK=${AUTO_START_NGROK:-true}
      - NGROK_SUBDOMAIN=${NGROK_SUBDOMAIN:-}
      - NGROK_PORT=${NGROK_PORT:-8000}
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - meeting-bot-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000 && wget -q --spider http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  redis_data:

networks:
  meeting-bot-network:
    driver: bridge
